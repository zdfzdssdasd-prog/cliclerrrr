<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KotoKombat ‚Äî –∫–æ—Ç–æ–∫—Ä–æ–ª–∏–∫–∏ & –º–æ–Ω–µ—Ç—ã</title>
  <meta name="description" content="KotoKombat ‚Äî –∫–ª–∏–∫–µ—Ä –ø—Ä–æ –∫–æ—Ç–æ–∫—Ä–æ–ª–∏–∫–æ–≤, –∞–ø–≥—Ä–µ–π–¥—ã –∏ –±–∏–∑–Ω–µ—Å—ã. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Firebase, –æ—Ñ—Ñ–ª–∞–π–Ω-–¥–æ—Ö–æ–¥, —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID, airdrop-–∑–∞—è–≤–∫–∏." />
  <style>
    :root {
      --bg1: #0f1224;
      --bg2: #1b1f3a;
      --card: rgba(255,255,255,0.08);
      --card-strong: rgba(255,255,255,0.16);
      --accent: #7c5cff;
      --accent2: #35d0ff;
      --good: #5CFF95;
      --warn: #ffd166;
      --bad: #ff5c7a;
      --text: #eaf1ff;
      --muted: #a9b3d0;
      --coin: #ffd54a;
      --energy: #8affff;
      --shadow: 0 10px 30px rgba(0,0,0,0.35);
      --radius: 18px;
      --radius-sm: 12px;
      --blur: saturate(1.1) blur(6px);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
      color: var(--text);
      background: radial-gradient(1200px 800px at 20% 10%, #1b2145 0%, #151831 40%, #0b0e1e 100%),
                  linear-gradient(135deg, var(--bg1), var(--bg2));
      background-attachment: fixed;
      overflow-x: hidden;
    }

    .app {
      display: grid;
      grid-template-columns: 330px 1fr 360px;
      gap: 16px; padding: 16px; max-width: 1400px; margin: 0 auto;
    }

    header.topbar {
      grid-column: 1 / -1;
      display: flex; align-items: center; justify-content: space-between;
      background: linear-gradient(135deg, rgba(124,92,255,0.28), rgba(53,208,255,0.18));
      border: 1px solid rgba(255,255,255,0.14);
      box-shadow: var(--shadow);
      padding: 12px 16px; border-radius: var(--radius);
      position: sticky; top: 8px; backdrop-filter: var(--blur); z-index: 10;
    }
    .brand { display: flex; align-items: center; gap: 12px; font-weight: 800; letter-spacing: 0.3px; }
    .brand .logo { width: 36px; height: 36px; border-radius: 50%; background:
      radial-gradient(10px 10px at 30% 30%, #fff8, #fff0),
      radial-gradient(circle at 70% 30%, #fff8 0 8px, #0000 9px),
      radial-gradient(18px 18px at 50% 70%, #ff66a1aa, #ff66a100),
      conic-gradient(from 0deg, #7c5cff, #35d0ff, #7c5cff);
      box-shadow: inset 0 0 12px #0008, 0 6px 16px #0008;
    }

    .statline { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    .pill { background: linear-gradient(135deg, var(--card), transparent); border: 1px solid rgba(255,255,255,0.16); padding: 8px 12px; border-radius: 999px; font-weight: 600; color: var(--text); display: inline-flex; gap: 8px; align-items: center; box-shadow: var(--shadow); }
    .pill .num { font-variant-numeric: tabular-nums; }

    .col { display: flex; flex-direction: column; gap: 16px; }
    .card { background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.04)); border: 1px solid rgba(255,255,255,0.16); border-radius: var(--radius); box-shadow: var(--shadow); padding: 16px; position: relative; overflow: hidden; }
    .card.solid { background: linear-gradient(180deg, rgba(255,255,255,0.18), rgba(255,255,255,0.12)); }

    h2 { margin: 0 0 10px; font-size: 18px; letter-spacing: 0.3px; }
    .muted { color: var(--muted); font-size: 14px; }

    .click-area { display: grid; place-items: center; min-height: 340px; border-radius: var(--radius); background: radial-gradient(400px 180px at 50% 0%, rgba(124,92,255,0.15), rgba(124,92,255,0)), radial-gradient(400px 180px at 50% 100%, rgba(53,208,255,0.12), rgba(53,208,255,0)), linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border: 1px dashed rgba(255,255,255,0.16); position: relative; overflow: hidden; }
    .big-btn { border: none; cursor: pointer; padding: 18px 26px; border-radius: 20px; background: linear-gradient(135deg, #8c6bff, #35d0ff); color: #0b0e1e; font-weight: 900; letter-spacing: 0.5px; font-size: 20px; box-shadow: 0 8px 20px rgba(53,208,255,0.25), 0 2px 0 rgba(0,0,0,0.25) inset; transition: transform 0.08s ease, filter 0.2s ease; user-select: none; }
    .big-btn:active { transform: translateY(1px) scale(0.995); filter: brightness(0.95); }

    .floating { position: absolute; font-weight: 800; pointer-events: none; opacity: 0; animation: pop 900ms ease forwards; }
    @keyframes pop { 0% { transform: translateY(0) scale(0.6); opacity: 0; } 15% { opacity: 1; } 100% { transform: translateY(-40px) scale(1); opacity: 0; } }

    .bar { height: 12px; background: rgba(255,255,255,0.10); border-radius: 999px; overflow: hidden; border: 1px solid rgba(255,255,255,0.16); }
    .bar > .fill { height: 100%; background: linear-gradient(90deg, var(--accent), var(--accent2)); width: 0%; transition: width 0.25s ease; }
    .bar.energy > .fill { background: linear-gradient(90deg, #8affff, #35d0ff); }

    .list { display: grid; gap: 10px; }
    .row { display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center; padding: 10px; border-radius: var(--radius-sm); background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03)); border: 1px solid rgba(255,255,255,0.16); }
    .row .title { font-weight: 700; }
    .row .subtitle { font-size: 13px; color: var(--muted); }
    .row .actions { display: flex; gap: 8px; align-items: center; }

    button.buy { border: 1px solid rgba(255,255,255,0.22); background: linear-gradient(135deg, rgba(124,92,255,0.30), rgba(53,208,255,0.24)); color: var(--text); border-radius: 12px; padding: 8px 12px; cursor: pointer; font-weight: 700; transition: transform 0.08s ease, filter 0.2s ease; box-shadow: var(--shadow); white-space: nowrap; }
    button.buy:disabled { filter: grayscale(0.8) opacity(0.6); cursor: not-allowed; }

    .tabs { display: flex; gap: 8px; margin-bottom: 8px; flex-wrap: wrap; }
    .tab { padding: 8px 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.16); background: rgba(255,255,255,0.06); cursor: pointer; font-weight: 700; }
    .tab.active { background: linear-gradient(135deg, rgba(124,92,255,0.38), rgba(53,208,255,0.26)); }

    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.68); display: none; align-items: center; justify-content: center; z-index: 50; }
    .modal { width: min(560px, 92vw); background: linear-gradient(180deg, rgba(255,255,255,0.14), rgba(255,255,255,0.10)); border: 1px solid rgba(255,255,255,0.22); border-radius: 16px; box-shadow: var(--shadow); padding: 16px; }
    .modal h3 { margin-top: 0; }
    .modal .grid { display: grid; gap: 10px; }
    .modal label { font-size: 14px; color: var(--muted); }
    .modal input, .modal textarea { width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.2); color: var(--text); }

    .footer { grid-column: 1 / -1; text-align: center; color: var(--muted); padding: 8px; font-size: 13px; }

    /* –ê–Ω–∏–º–∞—Ü–∏–∏ –¥–ª—è v4 */
    /* –ü–ª–∞–≤–Ω–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–µ–∫ –∏ —Ä—è–¥–æ–≤ */
    .card, .row {
      animation: fadeInUp 0.6s ease forwards;
      opacity: 0;
      transform: translateY(20px);
    }
    @keyframes fadeInUp {
      to { opacity: 1; transform: translateY(0); }
    }

    /* –£–ª—É—á—à–µ–Ω–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ –±–æ–ª—å—à—É—é –∫–Ω–æ–ø–∫—É */
    .big-btn {
      transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); /* –ë–æ–ª–µ–µ "–ø—Ä—É–∂–∏–Ω—è—â–∞—è" –∞–Ω–∏–º–∞—Ü–∏—è */
    }
    .big-btn:active {
      transform: translateY(4px) scale(0.98); /* –ë–æ–ª–µ–µ –≤—ã—Ä–∞–∂–µ–Ω–Ω–æ–µ –Ω–∞–∂–∞—Ç–∏–µ */
      box-shadow: 0 2px 8px rgba(53,208,255,0.3), 0 0 0 rgba(0,0,0,0.25) inset;
    }

    /* –ê–Ω–∏–º–∞—Ü–∏—è "–ø—É–ª—å—Å–∞" –¥–ª—è –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫ –ø–æ–∫—É–ø–∫–∏ */
    button.buy:not(:disabled) {
      position: relative;
      overflow: hidden;
    }
    button.buy:not(:disabled):after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
      animation: shine 1.5s ease-in-out infinite;
    }
    @keyframes shine {
      100% { left: 100%; }
    }

    /* –ê–Ω–∏–º–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —á–∏—Å–ª–æ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π */
    .pill .num {
      transition: all 0.5s ease-out;
    }
    .num.updated {
      color: var(--coin);
      text-shadow: 0 0 8px currentColor;
      animation: pulse 0.5s ease;
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.15); }
      100% { transform: scale(1); }
    }

    /* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è —ç–Ω–µ—Ä–≥–∏–∏ */
    .bar.energy > .fill {
      transition: width 0.8s cubic-bezier(0.22, 0.61, 0.36, 1);
    }

    @media (max-width: 1100px) { .app { grid-template-columns: 1fr; } header.topbar { position: static; } }
  </style>
</head>
<body>
  <div class="app">
    <header class="topbar">
      <div class="brand"><div class="logo"></div> KotoKombat <span class="muted">v4.0 (Firebase) ‚Äî Leaderboard & Animations</span></div>
      <div class="statline">
        <div class="pill">üí∞ –ú–æ–Ω–µ—Ç—ã: <span id="coins" class="num">0</span></div>
        <div class="pill">‚ö° –≠–Ω–µ—Ä–≥–∏—è: <span id="energyText" class="num">0/0</span></div>
        <div class="pill">üêæ –ö–æ—Ç–æ–∫—Ä–æ–ª–∏–∫–∏: <span id="petsCount" class="num">0</span></div>
        <div class="pill">üè™ –ë–∏–∑–Ω–µ—Å—ã: <span id="bizCount" class="num">0</span></div>
        <div class="pill">üÜî UID: <span id="playerId" class="num"></span></div>
      </div>
    </header>

    <section class="col">
      <div class="card">
        <h2>üêæ –ö–æ—Ç–æ–∫—Ä–æ–ª–∏–∫–∏</h2>
        <div class="muted">–ó–∞–≤–æ–¥–∏—Ç–µ –º–∏–ª—ã–µÔøΩ –∫–æ—Ç–æ–∫—Ä–æ–ª–∏–∫–æ–≤ ‚Äî –æ–Ω–∏ —É—Å–∏–ª–∏–≤–∞—é—Ç –∫–ª–∏–∫–∏ –∏ –ø–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥.</div>
        <div class="tabs" id="petTabs"></div>
        <div class="list" id="petsList"></div>
      </div>

      <div class="card">
        <h2>üõ†Ô∏è –£–ª—É—á—à–µ–Ω–∏—è</h2>
        <div class="muted">–ü—Ä–æ–∫–∞—á–∏–≤–∞–π—Ç–µ —Å–∏–ª—É –∫–ª–∏–∫–∞, –º–∞–∫—Å–∏–º—É–º –∏ —Ä–µ–≥–µ–Ω —ç–Ω–µ—Ä–≥–∏–∏.</div>
        <div class="list" id="upgradesList"></div>
      </div>
    </section>

    <section class="col">
      <div class="card click-area" id="clickArea">
        <button class="big-btn" id="clickBtn">–ö–õ–ò–ö ‚Äî +<span id="clickGain">1</span> üí∞</button>
        <div style="position:absolute;left:16px;right:16px;bottom:16px;display:grid;gap:8px;">
          <div class="muted">‚ö° –≠–Ω–µ—Ä–≥–∏—è</div>
          <div class="bar energy"><div id="energyBar" class="fill" style="width:0%"></div></div>
          <div class="muted">‚è±Ô∏è –î–æ—Ö–æ–¥/—Å–µ–∫: <span id="cps">0</span> ‚Ä¢ –î–æ—Ö–æ–¥/–∫–ª–∏–∫: <span id="cpc">1</span></div>
        </div>
      </div>

      <div class="card">
        <h2>üéØ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</h2>
        <div class="list" id="achievements"></div>
      </div>
    </section>


    <section class="col">
      <div class="card solid">
        <h2>‚ö° –£—Å–∏–ª–∏—Ç–µ–ª–∏ & –ï–∂–µ–¥–Ω–µ–≤–Ω–æ–µ</h2>
        <div class="list">
          <div class="row">
            <div>
              <div class="title">Turbo Paws (–∫–ª–∏–∫–∏ x2 –Ω–∞ 20 —Å–µ–∫)</div>
              <div class="subtitle">–¶–µ–Ω–∞: 30 —ç–Ω–µ—Ä–≥–∏–∏ ‚Ä¢ –ö–î 90 —Å–µ–∫. –°—Ç–∞—Ç—É—Å: <span id="boostStatus">–≥–æ—Ç–æ–≤–æ</span></div>
            </div>
            <div class="actions">
              <button class="buy" id="boostBtn">–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
          </div>
          <div class="row">
            <div>
              <div class="title">–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π —Å—É–Ω–¥—É–∫</div>
              <div class="subtitle">–ü–æ–ª—É—á–∞–π —Å–ª—É—á–∞–π–Ω–æ 250‚Äì750 –º–æ–Ω–µ—Ç —Ä–∞–∑ –≤ 20 —á–∞—Å–æ–≤. –°—Ç–∞—Ç—É—Å: <span id="dailyStatus">–¥–æ—Å—Ç—É–ø–µ–Ω?</span></div>
            </div>
            <div class="actions">
              <button class="buy" id="dailyBtn">–ó–∞–±—Ä–∞—Ç—å</button>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>üèÜ –¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤</h2>
        <div class="muted">–¢–æ–ø-10 –∏–≥—Ä–æ–∫–æ–≤ –ø–æ –º–æ–Ω–µ—Ç–∞–º.</div>
        <div class="list" id="leaderboardList">
          <div class="muted" id="leaderboardStatus">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
      </div>

      <div class="card">
        <h2>üè™ –ë–∏–∑–Ω–µ—Å—ã</h2>
        <div class="muted">–ê–≤—Ç–æ-–¥–æ—Ö–æ–¥ –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É. –°—Ç–æ–∏–º–æ—Å—Ç—å —Ä–∞—Å—Ç—ë—Ç —Å –ø–æ–∫—É–ø–∫–∞–º–∏.</div>
        <div class="list" id="bizList"></div>
      </div>

      <div class="card solid">
        <h2>ü™Ç Airdrop (–æ–Ω–ª–∞–π–Ω)</h2>
        <div class="muted">–ó–∞—è–≤–∫–∞ —É—Ö–æ–¥–∏—Ç –≤ Firestore. –ê–¥–º–∏–Ω –º–æ–∂–µ—Ç –æ–¥–æ–±—Ä–∏—Ç—å –∏ –Ω–∞—á–∏—Å–ª–∏—Ç—å –º–æ–Ω–µ—Ç—ã.</div>
        <div class="list">
          <button class="buy" id="airdropOpen">–°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É</button>
          <button class="buy" id="myReq">–ú–æ–∏ –∑–∞—è–≤–∫–∏</button>
          <div class="muted" id="airdropCount">–ó–∞—è–≤–æ–∫: 0</div>
          <div id="airdropList" class="list"></div>
        </div>
      </div>

      <div class="card">
        <h2>üë§ –ü—Ä–æ—Ñ–∏–ª—å</h2>
        <div class="list">
          <div class="row"><div><div class="title">UID</div><div class="subtitle" id="profileId">‚Äî</div></div><div class="actions"><button class="buy" id="copyId">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button></div></div>
          <div class="row"><div><div class="title">–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</div><div class="subtitle" id="joinDate">‚Äî</div></div></div>
          <div class="row"><div><div class="title">–í—Ä–µ–º—è –≤ –∏–≥—Ä–µ</div><div class="subtitle" id="playtime">0 –º–∏–Ω</div></div></div>
          <div class="row"><div><div class="title">–û—Ñ—Ñ–ª–∞–π–Ω-–¥–æ—Ö–æ–¥</div><div class="subtitle" id="offlineInfo">‚Äî</div></div></div>
          <div class="row"><div><div class="title">–≠–∫—Å–ø–æ—Ä—Ç –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∫—ç—à–∞</div><div class="subtitle">–¢–æ–ª—å–∫–æ –¥–ª—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ UI-—Å–æ—Å—Ç–æ—è–Ω–∏—è.</div></div>
            <div class="actions"><button class="buy" id="exportCache">–≠–∫—Å–ø–æ—Ä—Ç</button><button class="buy" id="wipeCache">–°–±—Ä–æ—Å –∫—ç—à–∞</button></div></div>
        </div>
      </div>
    </section>

    <div class="footer">¬© 2025 KotoKombat ‚Äî Firebase –≤–µ—Ä—Å–∏—è. üê±üêá</div>
  </div>

  <div class="modal-backdrop" id="modalBackdrop">
    <div class="modal">
      <h3>–ó–∞—è–≤–∫–∞ –Ω–∞ Airdrop</h3>
      <div class="grid">
        <label>–í–∞—à UID</label>
        <input id="air_id" type="text" readonly />
        <label>–ü—Ä–∏—á–∏–Ω–∞</label>
        <textarea id="air_reason" rows="3" placeholder="–ü–æ—á–µ–º—É –≤—ã —Ö–æ—Ç–∏—Ç–µ airdrop?"></textarea>
        <label>–ñ–µ–ª–∞–µ–º–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–æ–Ω–µ—Ç</label>
        <input id="air_amount" type="number" min="1" step="1" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, 1000" />
        <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:8px;">
          <button class="buy" id="air_cancel">–û—Ç–º–µ–Ω–∞</button>
          <button class="buy" id="air_submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    // ===== –ë–∞–∑–æ–≤–∞—è –∑–∞—â–∏—Ç–∞ –æ—Ç –ø—Ä–æ—Å—Ç–æ–≥–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤ DevTools =====
    document.addEventListener('keydown', function(e) {
      // F12, Ctrl+Shift+I, Ctrl+Shift+C, Ctrl+U
      if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && e.key === 'I') || (e.ctrlKey && e.shiftKey && e.key === 'C') || (e.ctrlKey && e.key === 'U')) {
        e.preventDefault();
        alert('–û—Ç–ª–∞–¥–∫–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∞ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏–≥—Ä—ã.');
        return false;
      }
    });
    // –£—Å–ª–æ–∂–Ω–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã —Å –∫–æ–Ω—Å–æ–ª—å—é
    setInterval(() => {
      console.clear();
      console.log('%cüö´ –°—Ç–æ–ø!', 'color: red; font-size: 40px; font-weight: bold;');
      console.log('%c–≠—Ç–æ –±—Ä–∞—É–∑–µ—Ä–Ω–∞—è –∫–æ–Ω—Å–æ–ª—å. –ï—Å–ª–∏ –≤–∞–º —Å–∫–∞–∑–∞–ª–∏ —á—Ç–æ-—Ç–æ –∑–¥–µ—Å—å –≤–≤–µ—Å—Ç–∏ –∏–ª–∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å, —ç—Ç–æ –º–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–æ. –ò–∑–º–µ–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–≥—Ä—ã –ø—Ä–∏–≤–µ–¥–µ—Ç –∫ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ –∞–∫–∫–∞—É–Ω—Ç–∞.', 'color: white; font-size: 16px;');
    }, 2000);

    // ===== Firebase SDK (modular) =====
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, onSnapshot, runTransaction, serverTimestamp, collection, addDoc, query, where, getDocs, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCEAzZ7hRe1PuVBivbkr-bBCsXt4_NqbWU",
      authDomain: "kotokombat-3ef45.firebaseapp.com",
      projectId: "kotokombat-3ef45",
      storageBucket: "kotokombat-3ef45.firebasestorage.app",
      messagingSenderId: "656929917626",
      appId: "1:656929917626:web:e12da76595680e677cd083"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ===== Utilities =====
    const fmt = n => Number(n||0).toLocaleString('ru-RU');
    const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
    const now = () => Date.now();

    // ===== Game static data =====
    const PETS = [
      { key: 'fluffy', name: '–§–ª–∞—Ñ—Ñ–∏', desc: '–¥–∞—ë—Ç +10% –∫ –¥–æ—Ö–æ–¥—É –∑–∞ –∫–ª–∏–∫', price: 50, clickMult: 0.10, cps: 0 },
      { key: 'espresso', name: '–≠—Å–ø—Ä–µ—Å—Å–æ', desc: '+5% –∫ –¥–æ—Ö–æ–¥—É/—Å–µ–∫', price: 150, clickMult: 0, cps: 0.05 },
      { key: 'spark', name: '–°–ø–∞—Ä–∫', desc: '+1 –∫ —Ä–µ–≥–µ–Ω—É —ç–Ω–µ—Ä–≥–∏–∏', price: 250, clickMult: 0, cps: 0, energyRegen: 1 },
      { key: 'jumper', name: '–î–∂–∞–º–ø–µ—Ä', desc: '+2 –∫ –º–∞–∫—Å–∏–º—É–º—É —ç–Ω–µ—Ä–≥–∏–∏', price: 200, clickMult: 0, cps: 0, maxEnergy: 2 },
    ];

    const BIZ = [
      { key:'cafe', name:'–ö–æ—Ñ–µ–π–Ω—è', base: 100, baseCps: 1 },
      { key:'bakery', name:'–ü–µ–∫–∞—Ä–Ω—è', base: 400, baseCps: 5 },
      { key:'electronics', name:'–ú–∞–≥–∞–∑–∏–Ω —ç–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∏', base: 2500, baseCps: 20 },
      { key:'bk', name:'¬´–ë—É—Ä–≥–µ—Ä –ö–∏–Ω–≥¬ª', base: 12000, baseCps: 75 },
      { key:'cinema', name:'–ö–∏–Ω–æ—Ç–µ–∞—Ç—Ä', base: 60000, baseCps: 300 },
      { key:'mall', name:'–¢–æ—Ä–≥–æ–≤—ã–π —Ü–µ–Ω—Ç—Ä', base: 300000, baseCps: 1500 },
    ];

    const UPGRADES = [
      { key:'cpc1', name:'–°–∏–ª–∞ –∫–ª–∏–∫–∞ x2', desc:'–£–¥–≤–∞–∏–≤–∞–µ—Ç –º–æ–Ω–µ—Ç—ã –∑–∞ –∫–ª–∏–∫. –°—Ç–æ–∏–º–æ—Å—Ç—å —Ä–∞—Å—Ç—ë—Ç.', base: 200, effect: lvl => Math.pow(2, lvl+1), type:'mult' },
      { key:'energyMax', name:'–ú–∞–∫—Å. —ç–Ω–µ—Ä–≥–∏—è +5', desc:'–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –º–∞–∫—Å–∏–º—É–º —ç–Ω–µ—Ä–≥–∏–∏ –Ω–∞ 5.', base: 150, effect: lvl => 5, type:'flatMaxEnergy' },
      { key:'energyRegen', name:'–†–µ–≥–µ–Ω —ç–Ω–µ—Ä–≥–∏–∏ +1', desc:'–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Ä–µ–≥–µ–Ω –Ω–∞ 1/—Å–µ–∫.', base: 250, effect: lvl => 1, type:'flatRegen' },
    ];

    const bizCost = (base, owned) => Math.floor(base * Math.pow(1.15, owned));
    const upgradeCost = (base, lvl) => Math.floor(base * Math.pow(1.8, lvl));
    const petCost = (base, owned) => Math.floor(base * Math.pow(1.35, owned));

    // ===== Derived values =====
    function petMultipliers(S) {
      let clickMult = 1, cpsMult = 1, addRegen = 0, addMax = 0;
      for(const p of PETS){
        const n = (S.pets?.[p.key]) || 0; if(!n) continue;
        if(p.clickMult) clickMult *= (1 + p.clickMult * n);
        if(p.cps) cpsMult *= (1 + p.cps * n);
        if(p.energyRegen) addRegen += p.energyRegen * n;
        if(p.maxEnergy) addMax += p.maxEnergy * n;
      }
      return { clickMult, cpsMult, addRegen, addMax };
    }

    function clickValue(S){
      const mults = petMultipliers(S);
      const base = (S.clickBase + S.clickBonus);
      const upgradeMult = Math.pow(2, S.upgrades.cpc1 || 0);
      let val = Math.max(1, Math.floor(base * upgradeMult * mults.clickMult));
      if((S?.boostUntil||0) > Date.now()) val *= 2; // turbo paws
      return val;
    }

    function totalCps(S){
      const mults = petMultipliers(S);
      let cps = 0; for(const b of BIZ){ const n = S.businesses[b.key]||0; cps += b.baseCps * n; }
      cps *= mults.cpsMult; return cps;
    }

    function maxEnergy(S){ return S.maxEnergy + (S.upgrades.energyMax||0) * 5 + petMultipliers(S).addMax; }
    function regenEnergy(S){ return S.energyRegen + (S.upgrades.energyRegen||0) * 1 + petMultipliers(S).addRegen; }

    // ===== UI Refs =====
    const elCoins = document.getElementById('coins');
    const elEnergyText = document.getElementById('energyText');
    const elEnergyBar = document.getElementById('energyBar');
    const elClickGain = document.getElementById('clickGain');
    const elCps = document.getElementById('cps');
    const elCpc = document.getElementById('cpc');
    const elPetsCount = document.getElementById('petsCount');
    const elBizCount = document.getElementById('bizCount');
    const elPlayerId = document.getElementById('playerId');

    const petTabs = document.getElementById('petTabs');
    const petsList = document.getElementById('petsList');
    const upgradesList = document.getElementById('upgradesList');
    const bizList = document.getElementById('bizList');
    const elAch = document.getElementById('achievements');
    const airdropList = document.getElementById('airdropList');
    const leaderboardList = document.getElementById('leaderboardList');
    const leaderboardStatus = document.getElementById('leaderboardStatus');

    const modalBackdrop = document.getElementById('modalBackdrop');
    const airOpen = document.getElementById('airdropOpen');
    const airId = document.getElementById('air_id');
    const airReason = document.getElementById('air_reason');
    const airAmount = document.getElementById('air_amount');
    const airCancel = document.getElementById('air_cancel');
    const airSubmit = document.getElementById('air_submit');
    const airdropCount = document.getElementById('airdropCount');
    const myReqBtn = document.getElementById('myReq');

    // ===== State in memory (mirror of Firestore) =====
    let UID = null;
    let S = null; // synced from Firestore

    // ===== Auth and first load =====
    onAuthStateChanged(auth, async (user)=>{
      if(user){ UID = user.uid; initUser(); }
    });
    await signInAnonymously(auth);

    async function initUser(){
      const ref = doc(db, 'users', UID);
      const snap = await getDoc(ref);
      if(!snap.exists()){
        const base = {
          version: 2,
          uid: UID,
          coins: 0,
          energy: 10, maxEnergy: 10, energyRegen: 1,
          clickBase: 1, clickBonus: 0,
          pets: {}, businesses: {}, upgrades: { cpc1: 0, energyMax: 0, energyRegen: 0 },
          joinTs: serverTimestamp(),
          playtimeSec: 0,
          lastActive: serverTimestamp(),
          lastTick: Date.now(),
          achievements: {},
        };
        await setDoc(ref, base);
      }
      onSnapshot(ref, (docSnap)=>{ if(docSnap.exists()){ S = materialize(docSnap.data()); renderAll(); }});
      // preload my requests count
      updateAirdropCount();
      loadLeaderboard();
    }

    function materialize(d){
      // convert Firestore Timestamps to numbers where needed
      const obj = { ...d };
      obj.pets = obj.pets || {}; obj.businesses = obj.businesses || {}; obj.upgrades = obj.upgrades || {cpc1:0,energyMax:0,energyRegen:0};
      if(typeof obj.lastTick !== 'number') obj.lastTick = Date.now();
      if(typeof obj.energy !== 'number') obj.energy = 10;
      return obj;
    }

    // ===== Rendering =====
    let activePetTab = 'all';

    function renderTop(){
      if(!S) return;

      // –ê–Ω–∏–º–∞—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –º–æ–Ω–µ—Ç
      const newCoins = Math.floor(S.coins);
      if (newCoins !== Number(elCoins.textContent.replace(/\s/g, ''))) {
        elCoins.textContent = fmt(newCoins);
        elCoins.classList.add('updated');
        setTimeout(() => elCoins.classList.remove('updated'), 500);
      }

      // –ê–Ω–∏–º–∞—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —ç–Ω–µ—Ä–≥–∏–∏
      const me = maxEnergy(S);
      const e = clamp(S.energy, 0, me);
      const newEnergyText = `${Math.floor(e)} / ${me}`;
      if (newEnergyText !== elEnergyText.textContent) {
        elEnergyText.textContent = newEnergyText;
        elEnergyText.classList.add('updated');
        setTimeout(() => elEnergyText.classList.remove('updated'), 500);
      }
      elEnergyBar.style.width = `${(e/me)*100}%`;

      elClickGain.textContent = fmt(clickValue(S));
      elCps.textContent = fmt(totalCps(S).toFixed(1));
      elCpc.textContent = fmt(clickValue(S));
      const petsOwned = Object.values(S.pets).reduce((a,b)=>a+b,0);
      const bizOwned = Object.values(S.businesses).reduce((a,b)=>a+b,0);
      elPetsCount.textContent = fmt(petsOwned);
      elBizCount.textContent = fmt(bizOwned);
      elPlayerId.textContent = UID?.slice(0,8) || '';

      document.getElementById('profileId').textContent = UID || '‚Äî';
      document.getElementById('joinDate').textContent = S.joinTs?.toDate ? S.joinTs.toDate().toLocaleString('ru-RU') : '‚Äî';
    }

    function renderPetTabs(){
      petTabs.innerHTML = '';
      const tabs = [ {k:'all', n:'–í—Å–µ'}, {k:'click', n:'–ö–ª–∏–∫'}, {k:'passive', n:'–ü–∞—Å—Å–∏–≤'}, {k:'energy', n:'–≠–Ω–µ—Ä–≥–∏—è'} ];
      for(const t of tabs){
        const b = document.createElement('button'); b.className = 'tab'+(activePetTab===t.k?' active':''); b.textContent = t.n;
        b.onclick = ()=>{ activePetTab=t.k; renderPets(); };
        petTabs.appendChild(b);
      }
    }
    function petCategory(p){ if(p.energyRegen || p.maxEnergy) return 'energy'; if(p.cps) return 'passive'; return 'click'; }

    function renderPets(){
      petsList.innerHTML = '';
      for(const p of PETS){
        if(activePetTab!=='all' && petCategory(p)!==activePetTab) continue;
        const owned = S?.pets?.[p.key]||0; const cost = petCost(p.price, owned);
        const row = document.createElement('div'); row.className='row';
        const title = document.createElement('div');
        title.innerHTML = `<div class="title">${p.name} √ó ${owned}</div><div class="subtitle">${p.desc} ‚Ä¢ –¶–µ–Ω–∞: <b>${fmt(cost)}</b></div>`;
        const actions = document.createElement('div'); actions.className='actions';
        const btn = document.createElement('button'); btn.className='buy'; btn.textContent='–ö—É–ø–∏—Ç—å'; btn.disabled = (S?.coins||0) < cost;
        btn.onclick = ()=> buyPet(p, cost);
        actions.appendChild(btn);
        row.appendChild(title); row.appendChild(actions);
        petsList.appendChild(row);
      }
    }

    function renderUpgrades(){
      upgradesList.innerHTML='';
      for(const u of UPGRADES){
        const lvl = S?.upgrades?.[u.key]||0; const cost = upgradeCost(u.base, lvl);
        const row = document.createElement('div'); row.className='row';
        const title = document.createElement('div');
        title.innerHTML = `<div class="title">${u.name} (—É—Ä. ${lvl})</div><div class="subtitle">${u.desc} ‚Ä¢ –¶–µ–Ω–∞: <b>${fmt(cost)}</b></div>`;
        const actions = document.createElement('div'); actions.className='actions';
        const btn = document.createElement('button'); btn.className='buy'; btn.textContent='–£–ª—É—á—à–∏—Ç—å'; btn.disabled = (S?.coins||0) < cost;
        btn.onclick = ()=> buyUpgrade(u, cost);
        actions.appendChild(btn);
        row.appendChild(title); row.appendChild(actions);
        upgradesList.appendChild(row);
      }
    }

    function renderBiz(){
      bizList.innerHTML='';
      for(const b of BIZ){
        const n = S?.businesses?.[b.key]||0; const cost = bizCost(b.base, n);
        const row = document.createElement('div'); row.className='row';
        const title = document.createElement('div');
        title.innerHTML = `<div class="title">${b.name} √ó ${n}</div><div class="subtitle">–î–æ—Ö–æ–¥: ${fmt(b.baseCps*n)}/—Å ‚Ä¢ –¶–µ–Ω–∞: <b>${fmt(cost)}</b></div>`;
        const actions = document.createElement('div'); actions.className='actions';
        const btn = document.createElement('button'); btn.className='buy'; btn.textContent='–ö—É–ø–∏—Ç—å'; btn.disabled = (S?.coins||0) < cost;
        btn.onclick = ()=> buyBusiness(b, cost);
        actions.appendChild(btn);
        row.appendChild(title); row.appendChild(actions);
        bizList.appendChild(row);
      }
    }

    const ACH = [
      { key:'firstClick', name:'–ü–µ—Ä–≤—ã–π –∫–ª–∏–∫', cond: s=>s._clicks>=1, reward: 10 },
      { key:'tenPets', name:'–ó–æ–æ–ø–∞—Ä–∫', cond: s=>Object.values(s.pets||{}).reduce((a,b)=>a+b,0)>=10, reward: 250 },
      { key:'rich', name:'–ü–µ—Ä–≤–∞—è —Ç—ã—Å—è—á–∞', cond: s=>s.coins>=1000, reward: 100 },
      { key:'bizman', name:'–ú–∞–ª—ã–π –±–∏–∑–Ω–µ—Å', cond: s=>Object.values(s.businesses||{}).reduce((a,b)=>a+b,0)>=5, reward: 150 },
    ];

    function renderAch(){
      elAch.innerHTML='';
      for(const a of ACH){
        const done = !!S.achievements?.[a.key];
        const row = document.createElement('div'); row.className='row';
        row.innerHTML = `<div><div class='title'>${a.name}</div><div class='subtitle'>–ù–∞–≥—Ä–∞–¥–∞: ${fmt(a.reward)} –º–æ–Ω–µ—Ç ‚Ä¢ ${done? '–ü–æ–ª—É—á–µ–Ω–æ ‚úÖ' : '–ù–µ –ø–æ–ª—É—á–µ–Ω–æ'}</div></div>`;
        const actions = document.createElement('div'); actions.className='actions';
        const btn = document.createElement('button'); btn.className='buy'; btn.textContent = done ? '–ì–æ—Ç–æ–≤–æ' : '–ó–∞–±—Ä–∞—Ç—å'; btn.disabled = done || !a.cond(S);
        btn.onclick = ()=> claimAch(a);
        actions.appendChild(btn); row.appendChild(actions); elAch.appendChild(row);
      }
    }

    function renderAll(){ renderTop(); renderPetTabs(); renderPets(); renderUpgrades(); renderBiz(); renderAch(); }

    // ===== Interactions with Firestore (transactions) =====
    async function txUpdate(mutator){
      const ref = doc(db, 'users', UID);
      await runTransaction(db, async (t)=>{
        const snap = await t.get(ref);
        const d = materialize(snap.data());
        const nd = await mutator(d);
        t.set(ref, nd, { merge: false });
      });
    }

    async function doClick(){
      if(!S) return;
      const me = maxEnergy(S); if(S.energy < 1) return;
      const gain = clickValue(S);
      S.energy = clamp(S.energy - 1, 0, me);
      S._clicks = (S._clicks||0) + 1;
      S.coins += gain;
      renderTop();
      pulseCoin(gain);
    }

    async function buyPet(p, cost){
      if((S?.coins||0) < cost) return;
      await txUpdate(d=>{ if(d.coins < cost) return d; d.coins -= cost; d.pets = d.pets||{}; d.pets[p.key]=(d.pets[p.key]||0)+1; return d; });
    }
    async function buyUpgrade(u, cost){
      if((S?.coins||0) < cost) return;
      await txUpdate(d=>{
        if(d.coins < cost) return d; d.coins -= cost; d.upgrades = d.upgrades||{}; d.upgrades[u.key]=(d.upgrades[u.key]||0)+1;
        if(u.type==='flatMaxEnergy') d.maxEnergy += u.effect(d.upgrades[u.key]-1);
        if(u.type==='flatRegen') d.energyRegen += u.effect(d.upgrades[u.key]-1);
        return d;
      });
    }
    async function buyBusiness(b, cost){
      if((S?.coins||0) < cost) return;
      await txUpdate(d=>{ if(d.coins < cost) return d; d.coins -= cost; d.businesses = d.businesses||{}; d.businesses[b.key]=(d.businesses[b.key]||0)+1; return d; });
    }

    async function claimAch(a){
      await txUpdate(d=>{ if(d.achievements?.[a.key]) return d; if(!a.cond(d)) return d; d.achievements = d.achievements||{}; d.achievements[a.key]=true; d.coins += a.reward; return d; });
    }

    // v3: Local ticker (no Firestore writes) every 1s; batched save every 12s.
    let lastSave = 0; let lastSnapshotWrite = 0; // to ignore echo snapshots
    setInterval(()=>{
      if(!S) return;
      const cps = totalCps(S);
      const regen = regenEnergy(S);
      const dt = 1;
      S.coins += cps * dt;
      S.energy = clamp(S.energy + regen*dt, 0, maxEnergy(S));
      S.playtimeSec = (S.playtimeSec||0) + dt;
      S.lastTick = Date.now();
      renderTop();
    }, 1000);

    // Throttled saver ‚Äî write diff fields only
    setInterval(async ()=>{
      if(!S || !UID) return;
      const ref = doc(db, 'users', UID);
      try {
        await setDoc(ref, {
          coins: Math.floor(S.coins),
          energy: Math.floor(S.energy),
          playtimeSec: Math.floor(S.playtimeSec||0),
          lastTick: S.lastTick,
          lastActive: serverTimestamp()
        }, { merge: true });
        lastSave = Date.now();
      } catch(e){ console.warn('save skipped', e); }
    }, 12000);

    // ===== Airdrop requests (stored in Firestore) =====
    function openModal(){ modalBackdrop.style.display='flex'; airId.value = UID; airReason.value=''; airAmount.value=''; }
    function closeModal(){ modalBackdrop.style.display='none'; }
    airOpen.onclick = openModal; airCancel.onclick = closeModal;

    airSubmit.onclick = async ()=>{
      const amount = Math.max(1, parseInt(airAmount.value||'0',10));
      const reason = (airReason.value||'').trim();
      if(!reason){ alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É.'); return; }
      await addDoc(collection(db, 'airdropRequests'), { uid: UID, reason, amount, status:'pending', createdAt: serverTimestamp() });
      closeModal(); updateAirdropCount(); alert('–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!');
    };

    async function updateAirdropCount(){
      if(!UID) return; const q = query(collection(db, 'airdropRequests'), where('uid','==',UID));
      const snap = await getDocs(q); document.getElementById('airdropCount').textContent = `–ó–∞—è–≤–æ–∫: ${snap.size}`;
    }

    myReqBtn.onclick = async ()=>{
      if(!UID) return; airdropList.innerHTML = '';
      const q = query(collection(db, 'airdropRequests'), where('uid','==',UID), orderBy('createdAt','desc'));
      const snap = await getDocs(q);
      snap.forEach(docu=>{
        const r = docu.data();
        const row = document.createElement('div'); row.className='row';
        row.innerHTML = `<div><div class='title'>${fmt(r.amount)} –º–æ–Ω–µ—Ç</div><div class='subtitle'>${r.reason} ‚Ä¢ –°—Ç–∞—Ç—É—Å: ${r.status||'pending'}</div></div>`;
        airdropList.appendChild(row);
      });
    };

    
    // ===== v3: Boosts & Daily =====
    const boostBtn = document.getElementById('boostBtn');
    const boostStatus = document.getElementById('boostStatus');
    const dailyBtn = document.getElementById('dailyBtn');
    const dailyStatus = document.getElementById('dailyStatus');

    function isBoostActive() { return (S?.boostUntil||0) > Date.now(); }
    function boostCooldownLeft() { return Math.max(0, (S?.boostCdUntil||0) - Date.now()); }

    function updateBoostUI(){
      if(!S) return;
      if(isBoostActive()){
        boostStatus.textContent = '–∞–∫—Ç–∏–≤–µ–Ω ' + Math.ceil((S.boostUntil - Date.now())/1000) + '—Å';
      } else {
        const cd = boostCooldownLeft();
        boostStatus.textContent = cd>0 ? ('–∫–¥ ' + Math.ceil(cd/1000) + '—Å') : '–≥–æ—Ç–æ–≤–æ';
      }
      document.getElementById('clickGain').textContent = fmt(clickValue(S));
      document.getElementById('cpc').textContent = fmt(clickValue(S));
    }
    setInterval(updateBoostUI, 500);

    boostBtn.onclick = ()=>{
      if(!S) return;
      if(boostCooldownLeft()>0){ return; }
      if(S.energy < 30){ alert('–ù—É–∂–Ω–æ 30 —ç–Ω–µ—Ä–≥–∏–∏.'); return; }
      S.energy -= 30;
      const nowTs = Date.now();
      S.boostUntil = nowTs + 20000; // 20s
      S.boostCdUntil = nowTs + 90000; // 90s
      renderTop();
      updateBoostUI();
    };

    function canClaimDaily(){
      const last = S?.dailyClaimAt || 0;
      const cooldownMs = 20 * 60 * 60 * 1000; // 20 —á–∞—Å–æ–≤
      return (Date.now() - last) >= cooldownMs;
    }
    function updateDailyUI(){
      dailyStatus.textContent = canClaimDaily()? '–¥–æ—Å—Ç—É–ø–µ–Ω' : '–æ–∂–∏–¥–∞–Ω–∏–µ';
    }
    setInterval(updateDailyUI, 2000);

    dailyBtn.onclick = async () => {
      if (!S || !UID) return;
      if (!canClaimDaily()) return; // –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ –¥–ª—è UX

      const reward = Math.floor(250 + Math.random() * 500);
      
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
      await txUpdate(async (d) => {
        // –ü–æ–≤—Ç–æ—Ä—è–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —É–∂–µ –Ω–∞ –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö —Å —Å–µ—Ä–≤–µ—Ä–∞
        const lastServerClaim = d.dailyClaimAt || 0;
        const cooldownMs = 20 * 60 * 60 * 1000; // 20 —á–∞—Å–æ–≤
        if (Date.now() - lastServerClaim < cooldownMs) {
          // –ï—Å–ª–∏ —É–∂–µ –∑–∞–±—Ä–∞–ª–∏, –≤—ã—Ö–æ–¥–∏–º –∏–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
          console.log("–ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –Ω–∞–≥—Ä–∞–¥–∞ —É–∂–µ –±—ã–ª–∞ –ø–æ–ª—É—á–µ–Ω–∞ (–ø—Ä–æ–≤–µ—Ä–µ–Ω–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ)");
          return d;
        }
        
        // –ï—Å–ª–∏ –º–æ–∂–Ω–æ –∑–∞–±—Ä–∞—Ç—å - –Ω–∞—á–∏—Å–ª—è–µ–º –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è
        d.coins += reward;
        d.dailyClaimAt = Date.now(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Ä–µ–º—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
        alert('–ù–∞–≥—Ä–∞–¥–∞: ' + reward + ' –º–æ–Ω–µ—Ç!');
        return d;
      });
      // renderTop() –≤—ã–∑–æ–≤–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ —Å–Ω–µ–ø—à–æ—Ç–∞ –æ—Ç Firestore
    };

    // ===== Leaderboard =====
    async function loadLeaderboard() {
      try {
        leaderboardStatus.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
        // –°–æ–∑–¥–∞–µ–º –∑–∞–ø—Ä–æ—Å –∫ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ 'users', —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ 'coins' –ø–æ —É–±—ã–≤–∞–Ω–∏—é, –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º 10 –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏.
        const q = query(collection(db, 'users'), orderBy('coins', 'desc'), limit(10));
        const querySnapshot = await getDocs(q);

        leaderboardList.innerHTML = ''; // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ç—É—Å

        let rank = 1;
        querySnapshot.forEach((doc) => {
          const userData = doc.data();
          // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –¥–æ–∫—É–º–µ–Ω—Ç—ã –±–µ–∑ –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ —Å –Ω—É–ª–µ–≤—ã–º –±–∞–ª–∞–Ω—Å–æ–º
          if (!userData || typeof userData.coins === 'undefined') return;

          const row = document.createElement('div');
          row.className = 'row';
          // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º UID –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã
          const shortUid = userData.uid ? userData.uid.substring(0, 6) + '...' : '???';
          
          row.innerHTML = `
            <div>
              <div class="title">#${rank} ${shortUid}</div>
              <div class="subtitle">${fmt(Math.floor(userData.coins))} –º–æ–Ω–µ—Ç</div>
            </div>
          `;
          
          // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º —Ç–µ–∫—É—â–µ–≥–æ –∏–≥—Ä–æ–∫–∞
          if (userData.uid === UID) {
            row.style.background = 'linear-gradient(135deg, rgba(124,92,255,0.25), transparent)';
            row.style.borderColor = 'var(--accent)';
          }

          leaderboardList.appendChild(row);
          rank++;
        });

        if (rank === 1) {
          leaderboardStatus.textContent = '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤.';
          leaderboardList.appendChild(leaderboardStatus);
        }
      } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∞–±–ª–∏—Ü—ã –ª–∏–¥–µ—Ä–æ–≤:", error);
        leaderboardStatus.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏.';
        leaderboardList.innerHTML = '';
        leaderboardList.appendChild(leaderboardStatus);
      }
    }

    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –ª–∏–¥–µ—Ä–æ–≤ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –∏ –∑–∞—Ç–µ–º –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
    setInterval(loadLeaderboard, 30000); // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫

    // ===== FX & helpers =====
    const clickArea = document.getElementById('clickArea');
    const clickBtn = document.getElementById('clickBtn');
    clickBtn.addEventListener('click', ()=>{ if(S) doClick(); else shake(clickBtn); });

    function pulseCoin(amount){
      const f = document.createElement('div'); f.className='floating';
      f.style.left = (Math.random()*60+20)+'%'; f.style.bottom='60px';
      f.style.color = amount>=0? 'var(--coin)':'#ff8a8a';
      f.textContent = (amount>=0? '+':'') + fmt(Math.floor(amount));
      clickArea.appendChild(f); setTimeout(()=>f.remove(), 1200);
    }
    function shake(el){ el.style.transform = 'translateX(1px)'; setTimeout(()=>el.style.transform='', 120); }

    // Profile extras
    document.getElementById('copyId').onclick = async ()=>{
      try { await navigator.clipboard.writeText(UID||''); alert('UID —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!'); } catch(e){ alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å.'); }
    };

    function renderPlaytime(){ if(!S) return; const m = Math.floor((S.playtimeSec||0)/60), h=Math.floor(m/60), mm=m%60; document.getElementById('playtime').textContent = h>0? `${h} —á ${mm} –º–∏–Ω` : `${mm} –º–∏–Ω`; }
    setInterval(renderPlaytime, 1000);

    // Local cache (optional backup of last snapshot)
    document.getElementById('exportCache').onclick = ()=>{ const cache = { UID, S }; const blob = new Blob([JSON.stringify(cache)], {type:'application/json'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`kk_cache_${(UID||'user').slice(0,8)}.json`; a.click(); setTimeout(()=>URL.revokeObjectURL(url), 1000); };
    document.getElementById('wipeCache').onclick = ()=>{ localStorage.clear(); alert('–õ–æ–∫–∞–ª—å–Ω—ã–π –∫—ç—à –æ—á–∏—â–µ–Ω. (–û–±–ª–∞–∫–æ ‚Äî –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)'); };

    // Render bootstrap
    renderPetTabs();
  </script>
</body>
</html>
